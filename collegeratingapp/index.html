<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>College Preference Rating</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    textarea {
      resize: none;
      height: 100px;
    }
    .result {
      margin-top: 20px;
      text-align: center;
    }
    .score {
      font-size: 24px;
      font-weight: bold;
    }
    .feedback {
      font-size: 14px;
      color: #555;
    }
    .thinking {
      text-align: center;
      font-style: italic;
      color: #0d6efd;
    }
    .college-info {
      margin-top: 30px;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }
    .college-list {
      text-align: left;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      display: none;
    }
    .college-card {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid;
      background-color: white;
    }
    .tier-ivy {
      border-left-color: #28a745;
    }
    .tier-elite {
      border-left-color: #17a2b8;
    }
    .tier-high {
      border-left-color: #fd7e14;
    }
    .tier-mid {
      border-left-color: #6c757d;
    }
    .match-highlight {
      border: 2px solid #007bff;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>College Preference Rating [v1.5]</h1>
    <h6 style="text-align: center;">A little contraption made by Enty, don't take this completely seriously</h6>
    <br>
    <form id="eloForm">
      <div class="row mb-3">
        <div class="col-md-6 mb-3">
          <label for="age" class="form-label">Age</label>
          <select class="form-select" id="age" required>
            <option value="">Select age...</option>
            <option value="16">16 or younger</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19 or older</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label for="ethnicity" class="form-label">Ethnicity</label>
          <select class="form-select" id="ethnicity" required>
            <option value="">Select ethnicity...</option>
            <option value="asian">Asian</option>
            <option value="black">Black/African American</option>
            <option value="hispanic">Hispanic/Latino</option>
            <option value="white">White</option>
            <option value="native">Native American</option>
            <option value="pacific">Pacific Islander</option>
            <option value="multiple">Multiple Ethnicities</option>
            <option value="other">Other/Prefer not to say</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6 mb-3">
          <label for="state" class="form-label">State of Residence</label>
          <select class="form-select" id="state" required>
            <option value="">Select state...</option>
            <option value="AL">Alabama</option>
            <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option>
            <option value="CA">California</option>
            <option value="CO">Colorado</option>
            <option value="CT">Connecticut</option>
            <option value="DE">Delaware</option>
            <option value="FL">Florida</option>
            <option value="GA">Georgia</option>
            <option value="HI">Hawaii</option>
            <option value="ID">Idaho</option>
            <option value="IL">Illinois</option>
            <option value="IN">Indiana</option>
            <option value="IA">Iowa</option>
            <option value="KS">Kansas</option>
            <option value="KY">Kentucky</option>
            <option value="LA">Louisiana</option>
            <option value="ME">Maine</option>
            <option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option>
            <option value="MI">Michigan</option>
            <option value="MN">Minnesota</option>
            <option value="MS">Mississippi</option>
            <option value="MO">Missouri</option>
            <option value="MT">Montana</option>
            <option value="NE">Nebraska</option>
            <option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option>
            <option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option>
            <option value="NY">New York</option>
            <option value="NC">North Carolina</option>
            <option value="ND">North Dakota</option>
            <option value="OH">Ohio</option>
            <option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option>
            <option value="PA">Pennsylvania</option>
            <option value="RI">Rhode Island</option>
            <option value="SC">South Carolina</option>
            <option value="SD">South Dakota</option>
            <option value="TN">Tennessee</option>
            <option value="TX">Texas</option>
            <option value="UT">Utah</option>
            <option value="VT">Vermont</option>
            <option value="VA">Virginia</option>
            <option value="WA">Washington</option>
            <option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option>
            <option value="WY">Wyoming</option>
            <option value="DC">District of Columbia</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label for="income" class="form-label">Family Income Range</label>
          <select class="form-select" id="income" required>
            <option value="">Select income range...</option>
            <option value="low">Below $50,000</option>
            <option value="mid-low">$50,000 - $100,000</option>
            <option value="mid">$100,000 - $150,000</option>
            <option value="mid-high">$150,000 - $200,000</option>
            <option value="high">Above $200,000</option>
            <option value="prefer-not">Prefer not to say</option>
          </select>
        </div>
      </div>
      <div class="mb-3">
        <label for="academics" class="form-label" style="text-align: center;">Academics</label>
        <textarea class="form-control" id="academics" placeholder="Describe your academic achievements (GPA, test scores, advanced courses, academic honors)..." required></textarea>
        <div class="thinking d-none" id="thinking-academics">AI is thinking...</div>
        <div class="feedback mt-2" id="feedback-academics"></div>
      </div>
      <div class="mb-3">
        <label for="extracurriculars" class="form-label" style="text-align: center;">Extracurriculars</label>
        <textarea class="form-control" id="extracurriculars" placeholder="Describe your extracurricular activities (clubs, sports, leadership roles, community service, etc.)..." required></textarea>
        <div class="thinking d-none" id="thinking-extracurriculars">AI is thinking...</div>
        <div class="feedback mt-2" id="feedback-extracurriculars"></div>
      </div>
      <div class="mb-3">
        <label for="awards" class="form-label" style="text-align: center;">Awards & Competitions</label>
        <textarea class="form-control" id="awards" placeholder="Describe your awards, competition achievements, and recognitions (e.g., DECA ICDC, science fairs, olympiads, etc.)..." required></textarea>
        <div class="thinking d-none" id="thinking-awards">AI is thinking...</div>
        <div class="feedback mt-2" id="feedback-awards"></div>
      </div>
      <button type="submit" class="btn btn-primary w-100">Submit</button>
    </form>
    <div class="result">
      <h3>Your Score/Rating:</h3>
      <p class="score" id="totalScore">0</p>
    </div>
    
    <div class="college-info">
      <button class="btn btn-outline-info w-100" id="viewColleges">View Matching Colleges</button>
      <div class="college-list mt-3" id="collegeList">
        <h4>College Match by Score Range</h4>
        <p class="text-muted">Based on approximate competitive score ranges. Remember that college admissions consider many other factors!</p>
        
        <div class="college-card tier-ivy" id="tier-2800-3300">
          <h5>2800-3300: Ivy League+ Competitive</h5>
          <p>Harvard, Yale, Princeton, Stanford, MIT, Columbia, UPenn, Brown, Dartmouth, Cornell, Caltech, University of Chicago</p>
        </div>
        
        <div class="college-card tier-elite" id="tier-2400-2799">
          <h5>2400-2799: Elite Universities</h5>
          <p>Duke, Johns Hopkins, Northwestern, Rice, UC Berkeley, UCLA, Carnegie Mellon, Vanderbilt, Washington University in St. Louis, University of Michigan-Ann Arbor, NYU, Georgetown</p>
        </div>
        
        <div class="college-card tier-high" id="tier-2000-2399">
          <h5>2000-2399: Highly Selective Universities</h5>
          <p>University of Washington, Boston College, Emory, USC, University of Virginia, UNC Chapel Hill, University of Florida, Georgia Tech, UT Austin, University of Wisconsin-Madison, University of Illinois Urbana-Champaign</p>
        </div>
        
        <div class="college-card tier-mid" id="tier-1600-1999">
          <h5>1600-1999: Mid-to-High Selective Universities</h5>
          <p>Ohio State, Purdue, Penn State, Michigan State, University of Minnesota, Virginia Tech, Texas A&M, University of Maryland, Florida State, University of Pittsburgh, Arizona State University</p>
        </div>
        
        <div class="college-card" id="tier-below-1600">
          <h5>Below 1600: Regional and State Universities</h5>
          <p>Various regional state universities and liberal arts colleges with acceptance rates >50%</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('eloForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Get user inputs
      const age = document.getElementById('age').value;
      const ethnicity = document.getElementById('ethnicity').value;
      const state = document.getElementById('state').value;
      const income = document.getElementById('income').value;
      const academics = document.getElementById('academics').value;
      const extracurriculars = document.getElementById('extracurriculars').value;
      const awards = document.getElementById('awards').value;

      // Prepare data for AI evaluation
      const categories = [
        { name: 'Academics', description: academics, feedbackId: 'feedback-academics', thinkingId: 'thinking-academics' },
        { name: 'Extracurriculars', description: extracurriculars, feedbackId: 'feedback-extracurriculars', thinkingId: 'thinking-extracurriculars' },
        { name: 'Awards & Competitions', description: awards, feedbackId: 'feedback-awards', thinkingId: 'thinking-awards' }
      ];

      const scores = []; // Store scores for all categories

      // Evaluate each category using Gemini API
      for (const category of categories) {
        const categoryScore = await evaluateCategory(category.name, category.description, category.thinkingId, category.feedbackId);
        scores.push(categoryScore); // Add the score to the array
        console.log(`Category: ${category.name}, Score: ${categoryScore}`); // Debug log
      }

      // Calculate the total score correctly
      const totalScore = scores.reduce((sum, score) => sum + score, 0); // Sum all scores
      console.log(`Scores Array:`, scores); // Debug log
      console.log(`Total Score: ${totalScore}`); // Debug log

      // Display the total score
      document.getElementById('totalScore').textContent = `${totalScore} / 3300`;
      
      // Show the college match button after score is calculated
      document.getElementById('viewColleges').style.display = 'block';
    });

    // Toggle college list visibility
    document.getElementById('viewColleges').addEventListener('click', function() {
      const collegeList = document.getElementById('collegeList');
      if (collegeList.style.display === 'block') {
        collegeList.style.display = 'none';
        this.textContent = 'View Matching Colleges';
      } else {
        collegeList.style.display = 'block';
        this.textContent = 'Hide College List';
        
        // Highlight matching tier based on score
        highlightMatchingTier();
      }
    });

    function highlightMatchingTier() {
      // Remove any existing highlights
      document.querySelectorAll('.college-card').forEach(card => {
        card.classList.remove('match-highlight');
      });
      
      // Get the current score
      const scoreText = document.getElementById('totalScore').textContent;
      const score = parseInt(scoreText.split('/')[0].trim());
      
      // Determine which tier to highlight
      let tierId = '';
      if (score >= 2800) {
        tierId = 'tier-2800-3300';
      } else if (score >= 2400) {
        tierId = 'tier-2400-2799';
      } else if (score >= 2000) {
        tierId = 'tier-2000-2399';
      } else if (score >= 1600) {
        tierId = 'tier-1600-1999';
      } else {
        tierId = 'tier-below-1600';
      }
      
      // Apply highlight
      document.getElementById(tierId).classList.add('match-highlight');
      
      // Scroll to the highlighted tier
      document.getElementById(tierId).scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    async function evaluateCategory(categoryName, description, thinkingId, feedbackId) {
      try {
        // Show "AI is thinking" indicator
        const thinkingIndicator = document.getElementById(thinkingId);
        thinkingIndicator.classList.remove('d-none');

        // Get demographic factors
        const age = document.getElementById('age').value;
        const ethnicity = document.getElementById('ethnicity').value;
        const state = document.getElementById('state').value;
        const income = document.getElementById('income').value;

        // Replace with your actual Gemini API key
        const apiKey = 'AIzaSyBDDikmWp1XhhI2nzxhEszlrNYdYJkGS8s'; 
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        // Include demographic context in the evaluation prompt

        console.log(`Sending request to: ${url}`); // Debug log

        // Custom prompt based on category type
        let evaluationPrompt = "";
        if (categoryName === 'Academics') {
          evaluationPrompt = `You are a college admissions expert evaluating a student's academic profile. Consider the following demographic context:
Age: ${age}
Ethnicity: ${ethnicity}
State: ${state}
Family Income: ${income}

Rate their academics out of 1100 points based on the ACTUAL QUALITY of their achievements while considering their demographic context. Even brief mentions of impressive achievements should receive high scores if the achievement itself is significant (e.g., 4.0 unweighted GPA, multiple AP/IB courses with high grades, top percentile SAT/ACT scores, National Merit recognition).

Scoring guidelines:
- 900-1100: Exceptional academic profile (perfect/near-perfect GPA, top 1-2% test scores, many challenging courses)
- 700-899: Very strong academic profile (high GPA, excellent test scores, challenging curriculum)
- 500-699: Strong academic profile (good GPA, above-average test scores)
- 300-499: Average academic profile
- 0-299: Below average academic profile

Provide ONLY the numeric score first, followed by a brief explanation of your rating. Focus on quality of achievements, not length or detail of description.

Description:
${description}`;
        } else if (categoryName === 'Extracurriculars') {
          evaluationPrompt = `You are a college admissions expert evaluating a student's extracurricular activities. Consider the following demographic context:
Age: ${age}
Ethnicity: ${ethnicity}
State: ${state}
Family Income: ${income}

Rate their extracurricular profile out of 1100 points based on the ACTUAL QUALITY and impact of their activities while considering their demographic context. Even brief mentions of impressive extracurriculars should receive high scores if the activities themselves demonstrate significant commitment, leadership, impact, or excellence.

Scoring guidelines:
- 900-1100: Exceptional extracurricular profile (significant leadership roles, long-term commitment, major impact)
- 700-899: Very strong extracurricular profile (leadership positions, consistent involvement, demonstrated impact)
- 500-699: Strong extracurricular profile (active participation in multiple activities)
- 300-499: Average extracurricular involvement
- 0-299: Limited extracurricular involvement

Provide ONLY the numeric score first, followed by a brief explanation of your rating. Focus on quality of achievements, not length or detail of description.

Description:
${description}`;
        } else { // Awards & Competitions
          evaluationPrompt = `You are a college admissions expert evaluating a student's awards and competition achievements. Consider the following demographic context:
Age: ${age}
Ethnicity: ${ethnicity}
State: ${state}
Family Income: ${income}

Rate their accomplishments out of 1100 points based on the ACTUAL QUALITY of their achievements while considering their demographic context. Even brief mentions of impressive achievements should receive high scores if the achievement itself is significant (e.g., DECA ICDC qualification should score very high as it's a prestigious national/international event).

Scoring guidelines:
- 900-1100: Exceptional achievements (national/international recognition, rare and prestigious awards)
- 700-899: Very strong achievements (state-level recognition, high placement in competitive events)
- 500-699: Strong achievements (regional recognition, consistent competition success)
- 300-499: Average achievements (local recognition, participation in competitions)
- 0-299: Limited achievements

Provide ONLY the numeric score first, followed by a brief explanation of your rating. Focus on quality of achievements, not length or detail of description.

Description:
${description}`;
        }

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  {
                    text: evaluationPrompt,
                  },
                ],
              },
            ],
          }),
        });

        if (!response.ok) {
          throw new Error(`API request failed with status: ${response.status}`);
        }

        const data = await response.json();

        // Validate the response structure
        if (
          !data ||
          !data.candidates ||
          !data.candidates[0] ||
          !data.candidates[0].content ||
          !data.candidates[0].content.parts ||
          !data.candidates[0].content.parts[0] ||
          !data.candidates[0].content.parts[0].text
        ) {
          console.error('Unexpected response structure:', data);
          throw new Error('Invalid response from Gemini API');
        }

        const aiResponse = data.candidates[0].content.parts[0].text.trim();
        console.log(`Raw AI Response for ${categoryName}:`, aiResponse); // Debug log

        // Extract score more carefully
        const scoreRegex = /^\D*(\d{1,4})\D*$/;
        const firstLine = aiResponse.split('\n')[0].trim();
        const match = firstLine.match(scoreRegex);
        
        let score;
        if (match && match[1]) {
          score = parseInt(match[1], 10);
        } else {
          // If regex fails, try a more aggressive approach
          const numberOnly = firstLine.replace(/\D/g, '');
          // If the extracted number is longer than 4 digits, it might have captured "1100"
          if (numberOnly.length > 4) {
            // Take only the first 4 digits at most
            score = parseInt(numberOnly.substring(0, 4), 10);
          } else {
            score = parseInt(numberOnly, 10);
          }
        }
        
        // Validate the score
        if (isNaN(score)) {
          console.error(`Invalid score for ${categoryName}: "${firstLine}"`);
          score = 0; // Default to 0 if parsing fails
        }
        
        // Ensure the score is within bounds
        score = Math.max(0, Math.min(1100, score));

        // Extract feedback (everything after the first line)
        const feedback = aiResponse.split('\n').slice(1).join('\n').trim();

        // Hide "AI is thinking" indicator
        thinkingIndicator.classList.add('d-none');

        // Update feedback and score
        const feedbackElement = document.getElementById(feedbackId);
        feedbackElement.innerHTML = `<strong>Score:</strong> ${score} / 1100<br><strong>Feedback:</strong> ${feedback}`;

        return score;
      } catch (error) {
        console.error(`Error evaluating category ${categoryName}:`, error);

        // Hide "AI is thinking" indicator
        const thinkingIndicator = document.getElementById(thinkingId);
        thinkingIndicator.classList.add('d-none');

        // Update feedback with error message
        const feedbackElement = document.getElementById(feedbackId);
        feedbackElement.textContent = 'Error: Unable to evaluate this category.';

        return 0; // Default score in case of failure
      }
    }
  </script>
</body>
</html>
